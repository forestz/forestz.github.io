<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content="Forest Zeng's Blog"/><title>RabbitMQ集群 | 宝石乡人</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">RabbitMQ集群</h1><a id="logo" href="/">宝石乡人</a><p class="description">宝石乡人的博客</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">RabbitMQ集群</h1><div class="post-meta">2015年12月23日 | <span class="categories">分类于<a href="/categories/RabbitMQ/"> RabbitMQ</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#集群模式"><span class="toc-number">1.</span> <span class="toc-text">集群模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群配置"><span class="toc-number">2.</span> <span class="toc-text">集群配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Erlang_cookie"><span class="toc-number">2.1.</span> <span class="toc-text">Erlang cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#独立启动所有节点"><span class="toc-number">2.2.</span> <span class="toc-text">独立启动所有节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建集群"><span class="toc-number">2.3.</span> <span class="toc-text">创建集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重启集群节点"><span class="toc-number">2.4.</span> <span class="toc-text">重启集群节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#脱离集群"><span class="toc-number">2.5.</span> <span class="toc-text">脱离集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端连接集群"><span class="toc-number">3.</span> <span class="toc-text">客户端连接集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群中使用RAM节点"><span class="toc-number">4.</span> <span class="toc-text">集群中使用RAM节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建RAM节点"><span class="toc-number">4.1.</span> <span class="toc-text">创建RAM节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改节点类型"><span class="toc-number">4.2.</span> <span class="toc-text">修改节点类型</span></a></li></ol></li></ol></div></div><div class="post-content"><p>RabbitMQ是用分布式语言erlang开放，因此集群非常方便。RabbitMQ的集群节点包括RAM（内存）节点和disc（硬盘）节点，其差别为前者将数据放在内存，而后者将数据放在硬盘。每个节点可以为disc或者RAM节点，并且可以相互转化，关于disc和RAM节点的区别在后文会有提及。通常所有节点都是disc节点，RAM节点主要是用于在大集群环境中提高效率。</p>
<p>RabbitMQ集群不能很好的支持WAN，如果要考虑在WAN中使用集群功能，需要使用 <a href="https://www.rabbitmq.com/federation.html" target="_blank" rel="external">federation</a>或<a href="https://www.rabbitmq.com/shovel.html" target="_blank" rel="external">shovel</a>。</p>
<h2 id="集群模式">集群模式</h2><p>RabbitMQ的集群模式有两种：</p>
<ol>
<li><strong>普通模式</strong><br>普通模式为默认集群模式。该模式的显著特点是对于消息队列queue来说只存在于该queue被首次申明的节点上。例如：集群中有A、B、C三个节点，客户端X1连接在A节点上并申明创建队列Q，则Q只存在于A节点上。对于连接在A节点上的客户端，如果要从队列Q中消费消息，则不会有任何影响；但是对于连接在B或者C上的客户端来说，如果也要从消费队列Q中的消息，则RabbitMQ会讲消息实体从A取出，然后传送给B或C节点，然后再由B活C返回给客户端。因此A会有性能瓶颈，且如果A节点出现故障，则B、C节点都无法消费A节点中所有队列的数据。</li>
<li><strong>镜像模式</strong><br>该模式解决了上述问题，其实质在于，消息会在多个镜像节点中同步，从而提高可靠性。本文接下来的内容都是讲普通模式，镜像模式属于RabbitMQ的HA方案，在下一篇再单独讲解。</li>
</ol>
<h2 id="集群配置">集群配置</h2><p>例如我们要在hostname为<em>rabbit1</em>和<em>rabbit2</em>两台机器上配置集群，首先要保证这两台机器能够通过hostname相互连通，如果不行可以在/etc/hosts文件中配置IP和hostname的映射，以保证连通。在修改hostname之后，需要重启RabbitMQ。</p>
<h3 id="Erlang_cookie">Erlang cookie</h3><p>Erlang节点之间使用cookie来检测他们是否可以进行通信，两个节点要进行交互，则必须使用相同的cookie。这个cookie是一串字符串，集群中所有节点必须使用相同的cookie，cookie同时也被<em>rabbitmqctl</em>、<em>rabbitmq-plugins</em>等工具使用。</p>
<p>在RabbitMQ服务启动时Erlang会自动创建一个随机cookie，一般情况下在unix系统中这个文件的路径为：<em>/var/lib/rabbitmq/.erlang.cookie</em> 或者 <em>$HOME/.erlang.cookie</em>；在windows系统，该文件的路径为：<em>C:\Users\Current User.erlang.cookie</em>、<em>C:\Documents and Settings\Current User.erlang.cookie</em>或<em>C:\Windows.erlang.cookie</em>。</p>
<p>让集群节点共享cookie最最简单的方式就是让一个节点创建该文件，然后将该文件复制到其他节点。</p>
<h3 id="独立启动所有节点">独立启动所有节点</h3><p>集群配置通过将普通节点进行重新配置加入到集群中，因此需要在所有节点上将RabbitMQ独立启动。<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbit1$ rabbitmq-<span class="keyword">server</span> -detached</span><br><span class="line">rabbit2$ rabbitmq-<span class="keyword">server</span> -detached</span><br></pre></td></tr></table></figure></p>
<p>如此启动两台独立的RabbitMQ服务器，在每个节点上执行<strong>_cluster<em>status</em></strong>命令查看集群状态。<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="atom">rabbit1</span>$ <span class="atom">rabbitmqctl</span> <span class="atom">cluster_status</span></span><br><span class="line"><span class="name">Cluster</span> <span class="atom">status</span> <span class="atom">of</span> <span class="atom">node</span> <span class="atom">rabbit</span>@<span class="atom">rabbit1</span> ...</span><br><span class="line">[&#123;<span class="atom">nodes</span>,[&#123;<span class="atom">disc</span>,[<span class="atom">rabbit</span>@<span class="atom">rabbit1</span>]&#125;]&#125;,&#123;<span class="atom">running_nodes</span>,[<span class="atom">rabbit</span>@<span class="atom">rabbit1</span>]&#125;]</span><br><span class="line">...<span class="atom">done</span>.</span><br><span class="line"></span><br><span class="line"><span class="atom">rabbit2</span>$ <span class="atom">rabbitmqctl</span> <span class="atom">cluster_status</span></span><br><span class="line"><span class="name">Cluster</span> <span class="atom">status</span> <span class="atom">of</span> <span class="atom">node</span> <span class="atom">rabbit</span>@<span class="atom">rabbit2</span> ...</span><br><span class="line">[&#123;<span class="atom">nodes</span>,[&#123;<span class="atom">disc</span>,[<span class="atom">rabbit</span>@<span class="atom">rabbit2</span>]&#125;]&#125;,&#123;<span class="atom">running_nodes</span>,[<span class="atom">rabbit</span>@<span class="atom">rabbit2</span>]&#125;]</span><br><span class="line">...<span class="atom">done</span>.</span><br></pre></td></tr></table></figure></p>
<h3 id="创建集群">创建集群</h3><p>为了将两个节点连接起来组建集群，需要让其中一个节点（<em>rabbit1</em>）保存运行状态，然后将另一个节点（<em>rabbit2</em>）去加入到第一个节（<em>rabbit1</em>）点，从而形成集群。</p>
<p><em>加入一个集群，会完全重置该节点，包括之前保存在节点上的所有资源和数据</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rabbit2$ rabbitmqctl stop_app</span><br><span class="line">Stopping <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 ...done.</span><br><span class="line"></span><br><span class="line">rabbit2$ rabbitmqctl join_cluster rabbit@rabbit1</span><br><span class="line">Clustering <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 with [rabbit@rabbit1] ...done.</span><br><span class="line"></span><br><span class="line">rabbit2$ rabbitmqctl start_app</span><br><span class="line">Starting <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 ...done.</span><br></pre></td></tr></table></figure>
<p>如此在每个节点上执行<strong>_cluster<em>status</em></strong>命令查看集群状态。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rabbit1<span class="variable">$ </span>rabbitmqctl cluster_status</span><br><span class="line"><span class="constant">Cluster</span> status <span class="keyword">of</span> node rabbit<span class="variable">@rabbit1</span> ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit<span class="variable">@rabbit1</span>,rabbit<span class="variable">@rabbit2</span>]&#125;]&#125;,&#123;running_nodes,[rabbit<span class="variable">@rabbit1</span>,rabbit<span class="variable">@rabbit2</span>]&#125;]</span><br><span class="line">...done.</span><br><span class="line"></span><br><span class="line">rabbit2<span class="variable">$ </span>rabbitmqctl cluster_status</span><br><span class="line"><span class="constant">Cluster</span> status <span class="keyword">of</span> node rabbit<span class="variable">@rabbit2</span> ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit<span class="variable">@rabbit1</span>,rabbit<span class="variable">@rabbit2</span>]&#125;]&#125;,&#123;running_nodes,[rabbit<span class="variable">@rabbit1</span>,rabbit<span class="variable">@rabbit2</span>]&#125;]</span><br><span class="line">...done.</span><br></pre></td></tr></table></figure></p>
<h3 id="重启集群节点">重启集群节点</h3><p>加入集群的节点随时可能关闭、或者崩溃。在此情况下，剩余的集群节点不受影响地正常工作，当该节点重新启动后，会自动与其他节点同步并正常工作。但是有一下两点需要注意：</p>
<ol>
<li>当集群中所有节点都被关闭，必须先启动最后关机的节点。否则其他节点会等待最后一个disc节点上线，如果超过30秒，则启动失败。如果最后一个被关闭的节点不能被启动，则可以在其他节点中使用<strong>_forget_cluster<em>node</em></strong>命令将其从集群中移除，然后再启动。</li>
<li>当集群中的所有节点在不可控的情况下同时被关闭（如机房断电），此情况下所有节点都会认为有其他节点比自己后关闭，而导致集群不能再次正常启动。在此情况下可以在其中某一节点上运行<strong>_force<em>boot</em></strong>命令来强制使其启动，则其他节点便可以再次启动。</li>
</ol>
<h3 id="脱离集群">脱离集群</h3><p>当集群不在需要某个节点时，可以将其移除。例如要将rabbit2移除集群，则在rabbit2上运行如下命令即可：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rabbit2$ rabbitmqctl stop_app</span><br><span class="line">Stopping <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 ...done.</span><br><span class="line"></span><br><span class="line">rabbit2$ rabbitmqctl reset</span><br><span class="line">Resetting <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit3 ...done.</span><br><span class="line"></span><br><span class="line">rabbit2$ rabbitmqctl start_app</span><br><span class="line">Starting <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 ...done.</span><br></pre></td></tr></table></figure></p>
<h2 id="客户端连接集群">客户端连接集群</h2><p>客户端像使用单节点一样连接到任意一个集群中的节点，当该节点宕机时，客户端会收到一个连接关闭的通知，然后可以尝试连接集群中的其他节点。集群节点的数量可能会随着集群的使用情况进行变更，因此不推荐将集群中的所有节点的地址信息配置在客户端的程序中，而导致程序客户端程序丧失灵活性。因此，推荐使用动态DNS服务，TCP负载均衡等工具，从而保证在集群节点发生变化时不需要更新客户端程序及配置。如下图所示，集群中使用Nginx或者HAProxy做TCP的负载均衡，因此对于客户端来说，只需要连接到10.1.10.110即可。</p>
<p><img src="/images/rabbitmq/rabbitmq-client.jpg" alt="客户端连接集群"></p>
<h2 id="集群中使用RAM节点">集群中使用RAM节点</h2><p>RAM节点不像disc节点将需要读写disc，而将metadata都保存在内存中，因此有更好的性能。但是，持久化的队列数据需要被存储到disc，所以RAM的性能只体现在资源管理上（如添加/删除队列、Exchange活着VHost），而不是在消息的发布和消费上。</p>
<p>一个只有RAM节点的集群是及其脆弱的，如果集群所有都宕机，则不能再次被启动，并且所有的数据都会被丢失。RabbitMQ会阻止创建只有RAM节点的集群，但是不能完全杜绝此类集群的创建。</p>
<h3 id="创建RAM节点">创建RAM节点</h3><p>在节点首次加入集群时，可以使用<em><em>–ram</em></em>参数表明已RAM节点的方式加入集群，命令如下：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rabbit2$ rabbitmqctl stop_app</span><br><span class="line">Stopping <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 ...done.</span><br><span class="line"></span><br><span class="line">rabbit2$ rabbitmqctl join_cluster --ram rabbit@rabbit1</span><br><span class="line">Clustering <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 with [rabbit@rabbit1] ...done.</span><br><span class="line"></span><br><span class="line">rabbit2$ rabbitmqctl start_app</span><br><span class="line">Starting <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 ...done.</span><br></pre></td></tr></table></figure>
<h3 id="修改节点类型">修改节点类型</h3><p>在关闭节点的情况下，可以随时将节点从RAM和disc进行相互转换，命令如下：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rabbit2$ rabbitmqctl stop_app</span><br><span class="line">Stopping <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 ...done.</span><br><span class="line"></span><br><span class="line">rabbit2$ rabbitmqctl change_cluster_node_type disc</span><br><span class="line">Turning rabbit@rabbit2 into a disc <span class="keyword">node</span><span class="identifier"> </span><span class="title">...</span><br><span class="line">...done</span>.</span><br><span class="line"></span><br><span class="line">rabbit2$ rabbitmqctl start_app</span><br><span class="line">Starting <span class="keyword">node</span><span class="identifier"> </span><span class="title">rabbit</span>@rabbit2 ...done.</span><br></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/分布式/">分布式</a></div><div class="post-nav"><a href="/2015/12/31/rabbit-ha/" class="pre"><i class="icon-previous">RabbitMQ HA</i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://forestz.cn"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/分布式/" style="font-size: 15px;">分布式</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2015/12/31/rabbit-ha/">RabbitMQ HA</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/23/rabbitmq-cluster/">RabbitMQ集群</a></li></ul></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="https://github.com/tufu9441/maupassant-hexo" title="Hexo简洁主题推荐" target="_blank">Hexo简洁主题推荐</a></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">宝石乡人.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script></div></body></html>